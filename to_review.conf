#############################################################
# /etc/httpd/conf.d/maintenance_global.conf
#
# Configuration globale de maintenance.
#
# Pour activer le mode maintenance, créez l’un des fichiers suivants :
#   - /var/www/html/maintenance/ALL               (pour l'activation globale)
#   - /var/www/html/maintenance/<SERVER_NAME>       (pour un hôte spécifique)
#
# Cette configuration utilise SERVER_NAME (défini dans le VirtualHost)
# pour vérifier l’existence du fichier de bascule, évitant ainsi que le
# client manipule HTTP_HOST.
#
# De plus, l’accès direct à l’URL /maintenance (alias du répertoire
# contenant la page de maintenance) est bloqué pour toute requête externe,
# et autorisé uniquement lors d’un appel interne (ErrorDocument).
#############################################################

# 1. Définir globalement l'ErrorDocument pour le code 503
ErrorDocument 503 /maintenance/index.html

# 2. Rendre accessible le répertoire de maintenance pour le traitement interne
Alias /maintenance /var/www/html/maintenance

# 3. Règles globales de réécriture pour activer le mode maintenance
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Permet aux VirtualHosts d'hériter de cette règle avant leurs propres règles
    RewriteOptions InheritBefore
    #
    # Si l'un des fichiers de bascule existe :
    #    - /var/www/html/maintenance/ALL  (activation globale)
    #    - ou /var/www/html/maintenance/<SERVER_NAME> (activation pour un hôte précis)
    #
    # Et si REDIRECT_STATUS est vide (pour éviter les boucles sur l'erreur),
    # alors renvoyer immédiatement un code 503 et définir MAINTENANCE_MODE=1.
    #
    RewriteCond /var/www/html/maintenance/ALL -f [OR]
    RewriteCond /var/www/html/maintenance/%{SERVER_NAME} -f
    RewriteCond %{ENV:REDIRECT_STATUS} ^$
    RewriteRule ^ - [R=503,L,E=MAINTENANCE_MODE:1]
</IfModule>

# 4. Protéger l’accès direct au répertoire de maintenance
#
# Nous utilisons ici un bloc <Location> afin que, si une requête externe
# tente d’accéder à une URL commençant par /maintenance, elle soit refusée
# (sauf lorsqu’elle provient d’un appel interne d’ErrorDocument, auquel cas
# REDIRECT_STATUS est défini).
<Location "/maintenance">
    <If "%{ENV:REDIRECT_STATUS} == ''">
         Require all denied
    </If>
    <Else>
         Require all granted
    </Else>
</Location>
