#############################################################
# Configuration globale du mode maintenance pour tous les VHosts
#############################################################

# 1. Définir globalement l'ErrorDocument 503
ErrorDocument 503 /maintenance/index.html

# 2. Rendre le répertoire de maintenance accessible en interne
Alias /maintenance /var/www/html/maintenance
<Directory "/var/www/html/maintenance">
    Options -Indexes +FollowSymLinks +MultiViews
    AllowOverride None
    # Protection du répertoire maintenance en mode normal
    <IfModule mod_rewrite.c>
        RewriteEngine On
        # Si aucun fichier de bascule n'existe (mode maintenance non activé)
        RewriteCond /var/www/html/maintenance/ALL !-f
        RewriteCond /var/www/html/maintenance/%{HTTP_HOST} !-f
        RewriteRule ^ - [F,L]
    </IfModule>
    Require all granted
</Directory>

# 3. Installer la règle globale de maintenance
<IfModule mod_rewrite.c>
    RewriteEngine On
    # IMPORTANT : cette option permet aux VirtualHosts d'hériter de cette règle
    RewriteOptions InheritBefore
    # Si le fichier de bascule existe globalement ou pour l'hôte en cours…
    RewriteCond /var/www/html/maintenance/ALL -f [OR]
    RewriteCond /var/www/html/maintenance/%{HTTP_HOST} -f
    # … et que cette règle s'exécute sur la requête initiale (pour éviter une boucle)
    RewriteCond %{ENV:REDIRECT_STATUS} ^$
    # Alors, quelle que soit l'URL demandée, renvoyer la page de maintenance avec un code 503
    RewriteRule ^/(.*)$ /maintenance/index.html [R=503,L]
</IfModule>
